{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ai-assistant.com/schemas/strategy.schema.json",
  "title": "Trading Strategy Schema",
  "description": "JSON Schema for validating trading strategy YAML files",
  "type": "object",
  "required": ["strategy", "indicators", "entry", "exit"],
  "properties": {
    "strategy": {
      "type": "object",
      "required": ["name", "version", "description", "category", "market_type", "timeframe"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_]+$",
          "description": "Strategy name (alphanumeric and underscore only)"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+$",
          "description": "Version number (e.g., 1.0, 2.1)"
        },
        "author": {
          "type": "string"
        },
        "created": {
          "type": "string",
          "format": "date"
        },
        "description": {
          "type": "string",
          "minLength": 10
        },
        "category": {
          "type": "string",
          "enum": ["mean_reversion", "trend_following", "momentum", "breakout", "statistical_arbitrage", "hybrid"]
        },
        "market_type": {
          "type": "string",
          "enum": ["stocks", "crypto", "forex", "futures", "options"]
        },
        "timeframe": {
          "type": "string",
          "enum": ["1min", "5min", "15min", "hourly", "daily", "weekly", "monthly"]
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "indicators": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "output_column"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Indicator name from registry"
          },
          "parameters": {
            "type": "object",
            "description": "Indicator parameters (e.g., period: 14)"
          },
          "input_column": {
            "type": "string",
            "description": "Input column name (default: close)"
          },
          "output_column": {
            "type": "string",
            "description": "Output column name in DataFrame"
          },
          "description": {
            "type": "string"
          }
        }
      }
    },
    "universe": {
      "type": "object",
      "required": ["source"],
      "properties": {
        "source": {
          "type": "string",
          "enum": ["database", "file", "api"]
        },
        "database": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string"
            },
            "filter": {
              "type": "object",
              "properties": {
                "collections": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "query": {
                  "type": "object"
                }
              }
            }
          }
        },
        "file": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string"
            }
          }
        }
      }
    },
    "entry": {
      "type": "object",
      "required": ["conditions", "logic"],
      "properties": {
        "conditions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/conditionGroup"
          }
        },
        "logic": {
          "type": "string",
          "description": "Logical expression combining groups (e.g., 'group1 AND group2')"
        },
        "constraints": {
          "type": "object",
          "properties": {
            "max_positions": {
              "type": "integer",
              "minimum": 1
            },
            "position_sizing": {
              "type": "string",
              "enum": ["equal_weight", "risk_parity", "kelly", "volatility_adjusted"]
            },
            "risk_per_trade": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "exit": {
      "type": "object",
      "properties": {
        "profit_target": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "type": {
              "type": "string",
              "enum": ["percentage", "atr_multiple", "fixed_price"]
            },
            "value": {
              "type": "number"
            },
            "description": {
              "type": "string"
            }
          }
        },
        "stop_loss": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "type": {
              "type": "string",
              "enum": ["fixed", "trailing", "stepped_trailing", "atr"]
            },
            "initial_stop": {
              "type": "number"
            },
            "risk_unit": {
              "type": "number"
            },
            "description": {
              "type": "string"
            }
          }
        },
        "signal_exit": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "conditions": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/conditionGroup"
              }
            }
          }
        },
        "time_exit": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "max_holding_period": {
              "type": "integer",
              "minimum": 1
            },
            "description": {
              "type": "string"
            }
          }
        }
      }
    },
    "filters": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/filterRule"
      }
    },
    "risk_management": {
      "type": "object",
      "properties": {
        "initial_capital": {
          "type": "number",
          "minimum": 0
        },
        "max_portfolio_risk": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "max_position_size": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "max_sector_exposure": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "position_sizing": {
          "type": "object",
          "properties": {
            "method": {
              "type": "string",
              "enum": ["equal_weight", "risk_parity", "volatility_adjusted", "kelly"]
            },
            "base_risk": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "backtest": {
      "type": "object",
      "properties": {
        "start_date": {
          "type": "string",
          "format": "date"
        },
        "end_date": {
          "type": "string",
          "format": "date"
        },
        "costs": {
          "type": "object",
          "properties": {
            "commission": {
              "type": "number",
              "minimum": 0
            },
            "slippage": {
              "type": "number",
              "minimum": 0
            }
          }
        },
        "rebalance_frequency": {
          "type": "string",
          "enum": ["daily", "weekly", "monthly"]
        },
        "benchmark": {
          "type": "string"
        }
      }
    },
    "optimization": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "parameters": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "range": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": {
                  "type": "number"
                }
              },
              "step": {
                "type": "number"
              }
            }
          }
        },
        "objective": {
          "type": "string",
          "enum": ["sharpe_ratio", "total_return", "max_drawdown", "calmar_ratio", "sortino_ratio"]
        },
        "method": {
          "type": "string",
          "enum": ["grid_search", "random_search", "bayesian"]
        }
      }
    },
    "monitoring": {
      "type": "object",
      "properties": {
        "alerts": {
          "type": "object"
        }
      }
    }
  },
  "definitions": {
    "conditionGroup": {
      "type": "object",
      "required": ["group", "operator", "rules"],
      "properties": {
        "group": {
          "type": "string",
          "description": "Group identifier"
        },
        "operator": {
          "type": "string",
          "enum": ["AND", "OR", "NOT"]
        },
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/rule"
          }
        }
      }
    },
    "rule": {
      "type": "object",
      "required": ["indicator", "operator"],
      "properties": {
        "indicator": {
          "type": "string",
          "description": "Indicator column name"
        },
        "operator": {
          "type": "string",
          "enum": [">", ">=", "<", "<=", "==", "!=", "crosses_above", "crosses_below", "between", "in_list"]
        },
        "value": {
          "description": "Comparison value (number or string)"
        },
        "reference": {
          "type": "string",
          "description": "Reference column for comparison"
        },
        "multiplier": {
          "type": "number",
          "description": "Multiplier for reference value"
        },
        "function": {
          "type": "string",
          "description": "Function to apply (e.g., rolling_mean)"
        },
        "function_params": {
          "type": "object",
          "description": "Parameters for function"
        },
        "offset": {
          "type": "integer",
          "description": "Time offset for comparison (e.g., -1 for previous period)"
        },
        "lookback": {
          "type": "integer",
          "description": "Lookback period for crossover detection"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "filterRule": {
      "type": "object",
      "required": ["name", "indicator", "operator"],
      "properties": {
        "name": {
          "type": "string"
        },
        "indicator": {
          "type": "string"
        },
        "operator": {
          "type": "string",
          "enum": [">", ">=", "<", "<=", "==", "!="]
        },
        "value": {
          "description": "Filter threshold value"
        },
        "reference": {
          "type": "string"
        },
        "multiplier": {
          "type": "number"
        },
        "description": {
          "type": "string"
        }
      }
    }
  }
}
